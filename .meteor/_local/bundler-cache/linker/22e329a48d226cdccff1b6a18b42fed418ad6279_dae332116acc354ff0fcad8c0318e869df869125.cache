[{"type":"js","data":"/* Imports for global scope */\n\nMongoInternals = Package.mongo.MongoInternals;\nMongo = Package.mongo.Mongo;\nReactiveVar = Package['reactive-var'].ReactiveVar;\nTracker = Package.tracker.Tracker;\nDeps = Package.tracker.Deps;\nECMAScript = Package.ecmascript.ECMAScript;\nReactMeteorData = Package['react-meteor-data'].ReactMeteorData;\nSimpleSchema = Package['aldeed:simple-schema'].SimpleSchema;\nMongoObject = Package['aldeed:simple-schema'].MongoObject;\nShowdown = Package.markdown.Showdown;\nReactiveDict = Package['reactive-dict'].ReactiveDict;\nMeteor = Package.meteor.Meteor;\nglobal = Package.meteor.global;\nmeteorEnv = Package.meteor.meteorEnv;\nWebApp = Package.webapp.WebApp;\nWebAppInternals = Package.webapp.WebAppInternals;\nmain = Package.webapp.main;\n_ = Package.underscore._;\nDDP = Package['ddp-client'].DDP;\nDDPServer = Package['ddp-server'].DDPServer;\nLaunchScreen = Package['launch-screen'].LaunchScreen;\nBlaze = Package.ui.Blaze;\nUI = Package.ui.UI;\nHandlebars = Package.ui.Handlebars;\nSpacebars = Package.spacebars.Spacebars;\nmeteorInstall = Package.modules.meteorInstall;\nmeteorBabelHelpers = Package['babel-runtime'].meteorBabelHelpers;\nPromise = Package.promise.Promise;\nAutoupdate = Package.autoupdate.Autoupdate;\nHTML = Package.htmljs.HTML;\n\n","servePath":"/packages/global-imports.js"},{"type":"js","data":"var require = meteorInstall({\"imports\":{\"models.js\":function(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                             //\n// imports/models.js                                                                                           //\n//                                                                                                             //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                               //\nmodule.export({\n  Tellers: () => Tellers,\n  Stories: () => Stories,\n  Subjects: () => Subjects\n});\nlet Mongo;\nmodule.watch(require(\"meteor/mongo\"), {\n  Mongo(v) {\n    Mongo = v;\n  }\n\n}, 0);\nconst Tellers = new Mongo.Collection('teller');\nconst Stories = new Mongo.Collection('story');\nconst Subjects = new Mongo.Collection('subject');\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"session.js\":function(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                             //\n// imports/session.js                                                                                          //\n//                                                                                                             //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                               //\nclass PersistentSession {\n  constructor() {\n    if (!('__miniblog__' in localStorage)) {\n      localStorage['__miniblog__'] = '{}';\n    }\n  }\n\n  get(key) {\n    var all = getAll();\n    return all[key];\n  }\n\n  set(key, value) {\n    var all = getAll();\n    all[key] = value;\n    setAll(all);\n  }\n\n}\n\nfunction getAll() {\n  var all = localStorage['__miniblog__'];\n\n  try {\n    return JSON.parse(all);\n  } catch (e) {\n    console.log(e);\n    return null;\n  }\n}\n\nfunction setAll(all) {\n  localStorage['__miniblog__'] = JSON.stringify(all);\n}\n\nmodule.exportDefault(Session = new PersistentSession());\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}},\"redux\":{\"actions.js\":function(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                             //\n// redux/actions.js                                                                                            //\n//                                                                                                             //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                               //\nmodule.export({\n  LOGIN_TELLER: () => LOGIN_TELLER,\n  LOGOUT_TELLER: () => LOGOUT_TELLER,\n  loginTeller: () => loginTeller,\n  logoutTeller: () => logoutTeller\n});\nconst LOGIN_TELLER = 'LOGIN_TELLER';\nconst LOGOUT_TELLER = 'LOGOUT_TELLER';\n\nfunction loginTeller(teller) {\n  return {\n    type: LOGIN_TELLER,\n    payload: {\n      teller: teller\n    }\n  };\n}\n\nfunction logoutTeller() {\n  return {\n    type: LOGOUT_TELLER,\n    payload: true\n  };\n}\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n},\"index.js\":function(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                             //\n// redux/index.js                                                                                              //\n//                                                                                                             //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                               //\nlet Actions;\nmodule.watch(require(\"./actions\"), {\n  \"*\"(v) {\n    Actions = v;\n  }\n\n}, 0);\nlet Session;\nmodule.watch(require(\"../imports/session\"), {\n  default(v) {\n    Session = v;\n  }\n\n}, 1);\nconst initial_state = {\n  name: 'foo',\n  teller: null\n};\nmodule.exportDefault(function (state = initial_state, action) {\n  console.log('Reducer >> ', state, action);\n\n  if (action.type == Actions.loginTeller) {\n    Session.set('teller', action.teller);\n    return Object.assign({}, state, {\n      teller: action.teller\n    });\n  }\n\n  if (action.type == Actions.logoutTeller) {\n    Session.set('teller', null);\n    return Object.assign({}, state, {\n      teller: null\n    });\n  }\n\n  return state;\n});\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}},\"server\":{\"main.js\":function(require,exports,module){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                             //\n// server/main.js                                                                                              //\n//                                                                                                             //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                               //\nlet Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Tellers, Stories, Subjects;\nmodule.watch(require(\"../imports/models\"), {\n  Tellers(v) {\n    Tellers = v;\n  },\n\n  Stories(v) {\n    Stories = v;\n  },\n\n  Subjects(v) {\n    Subjects = v;\n  }\n\n}, 1);\nlet slugify;\nmodule.watch(require(\"slugify\"), {\n  default(v) {\n    slugify = v;\n  }\n\n}, 2);\nMeteor.startup(() => {// code to run on server at startup\n});\nMeteor.methods({\n  'register.teller'(teller) {\n    teller.subjects = [];\n    teller._id = Tellers.insert(teller);\n    return teller;\n  },\n\n  'login.teller'(teller) {\n    var teller = Tellers.findOne(teller);\n    return teller;\n  },\n\n  'panel.newStory'(story) {\n    // var subjects = resolveSubjects(story.subjects);\n    var subject_ids = [];\n    story.subjects.forEach((subject, i) => {\n      if (!('_id' in subject)) {\n        subject = findOrCreateSubject(subject);\n      }\n\n      subject_ids.push(subject._id);\n    });\n    story.subjects = subject_ids;\n    story._id = Stories.insert(story);\n    return story;\n  },\n\n  'panel.updateSubjects'({\n    teller_id,\n    subjects\n  }) {\n    var subject_ids = [],\n        subject_object;\n    console.log(subjects);\n    subjects.forEach((subject, i) => {\n      if (!('_id' in subject)) {\n        subject = findOrCreateSubject(subject);\n      }\n\n      subjects[i] = subject;\n      subject_ids.push(subject._id);\n    }); // Atualiza os subjects com os _ids\n\n    Tellers.update({\n      _id: teller_id\n    }, {\n      $set: {\n        subjects: subject_ids\n      }\n    });\n    return subjects;\n  },\n\n  'timeline.getStories'({\n    subjects,\n    story_ids\n  }) {\n    // Pega 20 histórias dos assuntos E que não estejam entre as histórias passadas\n    // Se não completou 20 histórias, pegue 20 histórias quaisquer que não estejam entre as histórias passadas\n    var amount = 20;\n    var stories = Stories.find({\n      $and: [{\n        subjects: {\n          $in: subjects\n        }\n      }, {\n        _id: {\n          $nin: story_ids\n        }\n      }]\n    }, {\n      limit: amount\n    }).fetch();\n\n    if (stories.length < amount) {\n      stories.forEach(story => {\n        story_ids.push(story._id);\n      });\n      var more_stories = Stories.find({\n        _id: {\n          $nin: story_ids\n        }\n      }, {\n        limit: amount - stories.length\n      }).fetch();\n      stories = stories.concat(more_stories);\n    }\n\n    return stories;\n  }\n\n});\n\nfunction findOrCreateSubject(subject) {\n  subject.slug = slugifySubject(subject.name);\n  subject_object = Subjects.findOne({\n    slug: subject.slug\n  });\n\n  if (!subject_object) {\n    subject._id = Subjects.insert(subject);\n  } else subject = subject_object;\n\n  return subject;\n}\n\nfunction slugifySubject(subject) {\n  return slugify(subject.trim(), '-', /[^a-zA-Z0-9 -]/g, true);\n}\n\nfunction resolveSubjects(subjects) {\n  return subjects.split(',').map(function (subject) {\n    return slugifySubject(subject);\n  });\n}\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}}},{\n  \"extensions\": [\n    \".js\",\n    \".json\"\n  ]\n});\nrequire(\"./redux/actions.js\");\nrequire(\"./redux/index.js\");\nrequire(\"./server/main.js\");","servePath":"/app.js","sourceMap":{"version":3,"sources":["imports/models.js","imports/session.js","redux/actions.js","redux/index.js","server/main.js"],"names":["module","export","Tellers","Stories","Subjects","Mongo","watch","require","v","Collection","PersistentSession","constructor","localStorage","get","key","all","getAll","set","value","setAll","JSON","parse","e","console","log","stringify","exportDefault","Session","LOGIN_TELLER","LOGOUT_TELLER","loginTeller","logoutTeller","teller","type","payload","Actions","default","initial_state","name","state","action","Object","assign","Meteor","slugify","startup","methods","subjects","_id","insert","findOne","story","subject_ids","forEach","subject","i","findOrCreateSubject","push","teller_id","subject_object","update","$set","story_ids","amount","stories","find","$and","$in","$nin","limit","fetch","length","more_stories","concat","slug","slugifySubject","trim","resolveSubjects","split","map"],"mappings":"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","file":"/app.js","sourcesContent":["import { Mongo } from 'meteor/mongo';\n\nexport const Tellers = new Mongo.Collection('teller');\nexport const Stories = new Mongo.Collection('story');\nexport const Subjects = new Mongo.Collection('subject');\n","class PersistentSession {\n  constructor(){\n    if(!('__miniblog__' in localStorage)){\n      localStorage['__miniblog__'] = '{}';\n    }\n  }\n\n  get(key){\n    var all = getAll();\n    return all[key];\n  }\n\n  set(key, value){\n    var all = getAll();\n    all[key] = value;\n    setAll(all);\n  }\n}\n\nfunction getAll(){\n  var all = localStorage['__miniblog__'];\n  try{\n    return JSON.parse(all);\n  }catch(e){\n    console.log(e);\n    return null;\n  }\n}\n\nfunction setAll(all){\n  localStorage['__miniblog__'] = JSON.stringify(all);\n}\n\nexport default Session = new PersistentSession();\n","export const LOGIN_TELLER = 'LOGIN_TELLER';\nexport const LOGOUT_TELLER = 'LOGOUT_TELLER';\n\nexport function loginTeller(teller){\n  return {\n    type: LOGIN_TELLER,\n    payload: {\n      teller: teller\n    }\n  };\n}\n\nexport function logoutTeller(){\n  return {\n    type: LOGOUT_TELLER,\n    payload: true\n  };\n}\n","import * as Actions from './actions';\nimport Session from '../imports/session';\n\nconst initial_state = {\n  name: 'foo',\n  teller: null\n};\n\nexport default function(state = initial_state, action){\n  console.log('Reducer >> ', state, action);\n\n  if(action.type == Actions.loginTeller){\n    Session.set('teller', action.teller);\n    return Object.assign({}, state, {teller: action.teller});\n  }\n\n  if(action.type == Actions.logoutTeller){\n    Session.set('teller', null);\n    return Object.assign({}, state, {teller: null});\n  }\n\n  return state;\n}\n","import { Meteor } from 'meteor/meteor';\nimport { Tellers, Stories, Subjects } from '../imports/models';\nimport slugify from 'slugify';\n\nMeteor.startup(() => {\n  // code to run on server at startup\n});\n\nMeteor.methods({\n  'register.teller'(teller){\n    teller.subjects = [];\n    teller._id = Tellers.insert(teller);\n\n    return teller;\n  },\n  'login.teller'(teller){\n    var teller = Tellers.findOne(teller);\n\n    return teller;\n  },\n  'panel.newStory'(story){\n    // var subjects = resolveSubjects(story.subjects);\n    var subject_ids = [];\n    story.subjects.forEach((subject, i)=>{\n      if(!('_id' in subject)){\n        subject = findOrCreateSubject(subject);\n      }\n\n      subject_ids.push(subject._id);\n    });\n\n    story.subjects = subject_ids;\n\n    story._id = Stories.insert(story);\n\n    return story;\n  },\n  'panel.updateSubjects'({teller_id, subjects}){\n    var subject_ids = [], subject_object;\n    console.log(subjects)\n\n    subjects.forEach((subject, i)=>{\n      if(!('_id' in subject)){\n        subject = findOrCreateSubject(subject);\n      }\n\n      subjects[i] = subject;\n      subject_ids.push(subject._id);\n    });\n\n    // Atualiza os subjects com os _ids\n    Tellers.update({_id: teller_id}, {$set: {subjects: subject_ids}});\n\n    return subjects;\n  },\n  'timeline.getStories'({subjects, story_ids}){\n    // Pega 20 histórias dos assuntos E que não estejam entre as histórias passadas\n    // Se não completou 20 histórias, pegue 20 histórias quaisquer que não estejam entre as histórias passadas\n    var amount = 20;\n    var stories = Stories.find({$and: [{subjects: {$in: subjects}}, {_id: {$nin: story_ids}}]}, {limit: amount}).fetch();\n    if(stories.length < amount){\n      stories.forEach((story)=>{\n        story_ids.push(story._id);\n      });\n\n      var more_stories = Stories.find({_id: {$nin: story_ids}}, {limit: amount-stories.length}).fetch();\n      stories = stories.concat(more_stories);\n    }\n\n    return stories;\n  }\n});\n\nfunction findOrCreateSubject(subject){\n  subject.slug = slugifySubject(subject.name);\n  subject_object = Subjects.findOne({slug: subject.slug});\n  if(!subject_object){\n    subject._id = Subjects.insert(subject);\n  }else subject = subject_object;\n\n  return subject;\n}\n\nfunction slugifySubject(subject){\n  return slugify(subject.trim(),'-',/[^a-zA-Z0-9 -]/g, true);\n}\n\nfunction resolveSubjects(subjects){\n  return subjects.split(',').map(function(subject){\n    return slugifySubject(subject);\n  });\n}\n"]}}]